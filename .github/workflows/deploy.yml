name: Deploy to Render

# Trigger only on commits to main that start with "deploy:"
on:
  push:
    branches:
      - main

jobs:
  check-deploy:
    name: Check if deployment needed
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: Check commit message
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" == deploy:* ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment triggered by commit: $COMMIT_MSG"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Skipping deployment (commit doesn't start with 'deploy:')"
          fi

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: check-deploy
    if: needs.check-deploy.outputs.should_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "ğŸš€ Deployment triggered on Render"

      - name: Wait for deployment
        run: |
          echo "â³ Waiting 60 seconds for deployment to start..."
          sleep 60

      - name: Health check
        run: |
          RENDER_URL="${{ secrets.RENDER_URL }}"
          MAX_RETRIES=15
          RETRY_COUNT=0
          
          echo "ğŸ” Starting health checks for $RENDER_URL"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            # Try to reach the application
            if curl -f -s -o /dev/null -w "%{http_code}" "$RENDER_URL" | grep -q "200\|301\|302"; then
              echo "âœ… Application is responding!"
              echo "ğŸ‰ Deployment successful!"
              exit 0
            fi
            
            echo "â³ Not ready yet, waiting 20 seconds..."
            sleep 20
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          echo "âš ï¸  Health check timeout - deployment may still be in progress"
          echo "Check Render dashboard: https://dashboard.render.com"
          exit 0  # Don't fail the workflow

      - name: Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
          echo "ğŸ”— URL: ${{ secrets.RENDER_URL }}"
          echo "ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}"
          echo "ğŸ• Time: $(date)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
